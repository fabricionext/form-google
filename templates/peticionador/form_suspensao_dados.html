{% extends "_base_peticionador.html" %} {% from "peticionador/_form_macros.html"
import render_field %} {% block title %}{{ title }}{% endblock %} {% block
content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>{{ title }}</h2>
  </div>

  <!-- Toggle Modo Cliente -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center">
        <div class="form-check form-check-inline me-4">
          <input
            class="form-check-input"
            type="radio"
            name="modo_cliente"
            id="modo_buscar"
            value="buscar"
            checked
          />
          <label class="form-check-label" for="modo_buscar">
            <i class="fas fa-search me-2"></i>Buscar Cliente por CPF
          </label>
        </div>
        <div class="form-check form-check-inline">
          <input
            class="form-check-input"
            type="radio"
            name="modo_cliente"
            id="modo_novo"
            value="novo"
          />
          <label class="form-check-label" for="modo_novo">
            <i class="fas fa-user-plus me-2"></i>Novo Cliente
          </label>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex gap-4">
    <!-- Formulário Principal -->
    <div class="flex-grow-1" style="max-width: 65%">
      <div class="row g-4">
        <!-- Busca de Cliente (Modo Buscar) -->
        <div class="col-lg-4" id="busca_cliente_section">
          <div class="card shadow-sm sticky-top" style="top: 20px">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="fas fa-search me-2"></i> Buscar Cliente
              </h5>
            </div>
            <div class="card-body">
              <div class="input-group">
                <span class="input-group-text"
                  ><i class="fas fa-id-card"></i
                ></span>
                <input
                  type="text"
                  id="cpf_busca"
                  class="form-control"
                  placeholder="Digite o CPF para buscar..."
                  autocomplete="off"
                />
              </div>
            </div>
            <div class="card-footer" id="cliente_card_container">
              <div class="text-center text-muted py-3" id="dados_cliente_area">
                <i class="fas fa-keyboard fa-2x mb-2"></i>
                <p class="mb-0">Aguardando digitação do CPF...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Formulário Principal -->
        <div class="col-lg-8" id="formulario_principal">
          <div id="drop_zone" class="card shadow-sm">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i> Petição</h5>
              <button
                type="button"
                id="toggle_preview"
                class="btn btn-outline-secondary btn-sm"
              >
                <i class="fas fa-eye me-1"></i>Preview
              </button>
            </div>
            <div class="card-body">
              <form
                method="POST"
                id="peticao_form"
                action="{{ url_for('peticionador.gerar_suspensao_peticao_dados_form') }}"
                novalidate
              >
                {{ form.hidden_tag() }}
                <input
                  type="hidden"
                  name="modelo_id"
                  value="{{ modelo.id or 'default' }}"
                />
                <input type="hidden" name="cliente_id" value="" />

                <div id="formulario_content">
                  <!-- Placeholder para arrastar cliente (modo buscar) -->
                  <div
                    class="text-center text-muted py-5"
                    id="drop_placeholder"
                  >
                    <i class="fas fa-hand-pointer fa-4x mb-3"></i>
                    <h5>Arraste o card do cliente aqui</h5>
                    <p>para preencher os dados automaticamente.</p>
                  </div>

                  <!-- Campos do formulário -->
                  <div class="d-none" id="peticao_fields">
                    <!-- Alert de cliente carregado -->
                    <div
                      class="alert alert-success d-flex justify-content-between align-items-center mb-4"
                      role="alert"
                      id="cliente_alert"
                    >
                      <div class="d-flex align-items-center">
                        <i class="fas fa-user-check fa-2x me-3"></i>
                        <div>
                          <h6 class="alert-heading mb-0" id="cliente_nome_form">
                            Cliente Carregado!
                          </h6>
                          <span class="small" id="cliente_cpf_form"></span>
                        </div>
                      </div>
                      <button
                        type="button"
                        id="btn_reset_cliente"
                        class="btn-close"
                        title="Trocar Cliente"
                      ></button>
                    </div>

                    <!-- Grid de campos organizados -->
                    <div class="form-grid">
                      <!-- Seção 1: Dados da Infração e Processo -->
                      <div class="form-section">
                        <div class="section-header">
                          <h6>
                            <i class="fas fa-file-invoice me-2"></i>1. Dados da
                            Infração e Processo
                          </h6>
                        </div>
                        <div class="section-content">
                          <div class="form-row">
                            <div class="form-col">
                              {{ render_field(form.numero_processo_adm) }}
                            </div>
                            <div class="form-col">
                              {{ render_field(form.artigo_infringido) }}
                            </div>
                            <div class="form-col">
                              {{ render_field(form.data_infracao, type='date')
                              }}
                            </div>
                            <div class="form-col">
                              {{ render_field(form.hora_infracao) }}
                            </div>
                            <div class="form-col-full">
                              {{ render_field(form.local_infracao) }}
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Seção 2: Detalhes da Penalidade -->
                      <div class="form-section">
                        <div class="section-header">
                          <h6>
                            <i class="fas fa-gavel me-2"></i>2. Detalhes da
                            Penalidade
                          </h6>
                        </div>
                        <div class="section-content">
                          <div class="form-row">
                            <div class="form-col">
                              {{ render_field(form.velocidade_limite) }}
                            </div>
                            <div class="form-col">
                              {{ render_field(form.velocidade_medida) }}
                            </div>
                            <div class="form-col">
                              {{ render_field(form.pontos_penalidade) }}
                            </div>
                            <div class="form-col">
                              {{ render_field(form.valor_multa) }}
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Seção 3: Observações Adicionais -->
                      <div class="form-section">
                        <div class="section-header">
                          <h6>
                            <i class="fas fa-plus-circle me-2"></i>3.
                            Observações Adicionais
                          </h6>
                        </div>
                        <div class="section-content">
                          <div class="form-row">
                            <div class="form-col-full">
                              {{ render_field(form.observacoes, rows='5') }}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Botões de ação -->
                    <div class="form-actions">
                      <button type="submit" class="btn btn-success btn-lg px-4">
                        <i class="fas fa-save me-2"></i> Gerar Documento
                      </button>
                      <a
                        href="#"
                        id="btn_cancelar_peticao"
                        class="btn btn-secondary btn-lg ms-2"
                      >
                        <i class="fas fa-times me-2"></i> Cancelar
                      </a>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview Panel -->
    <div id="preview_panel" class="preview-panel d-none">
      <div class="preview-header">
        <h6><i class="fas fa-eye me-2"></i>Preview do Documento</h6>
        <button type="button" id="close_preview" class="btn-close"></button>
      </div>
      <div class="preview-content">
        <div id="preview_loading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <p class="mt-2 text-muted">Gerando preview...</p>
        </div>
        <div id="preview_content" class="d-none">
          <!-- Conteúdo do preview será inserido aqui -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de detalhes do cliente -->
<div
  class="modal fade"
  id="clienteDetailModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user-tag me-2"></i> Detalhes do Cliente
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body" id="clienteModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast para notificações -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div
    id="appToast"
    class="toast"
    role="alert"
    aria-live="assertive"
    aria-atomic="true"
  >
    <div class="toast-header">
      <i class="fas fa-bell me-2"></i>
      <strong class="me-auto" id="toastTitle">Notificação</strong>
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="toast"
        aria-label="Close"
      ></button>
    </div>
    <div class="toast-body" id="toastBody">Mensagem.</div>
  </div>
</div>

{% endblock %} {% block styles %} {{ super() }}
<style>
  /* Grid Layout */
  .form-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
  }

  .section-header h6 {
    margin: 0;
    color: #495057;
    font-weight: 600;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
  }

  .form-col {
    display: flex;
    flex-direction: column;
  }

  .form-col-full {
    grid-column: 1 / -1;
  }

  /* Preview Panel */
  .preview-panel {
    width: 35%;
    background: #fff;
    border-left: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 200px);
    position: sticky;
    top: 20px;
  }

  .preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
  }

  .preview-header h6 {
    margin: 0;
    font-weight: 600;
  }

  .preview-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
  }

  /* Responsividade */
  @media (max-width: 1200px) {
    .form-row {
      grid-template-columns: 1fr;
    }

    .preview-panel {
      width: 100%;
      height: 400px;
      position: fixed;
      bottom: 0;
      left: 0;
      z-index: 1050;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }

    .preview-panel.show {
      transform: translateY(0);
    }
  }

  /* Animações */
  .fade-in {
    animation: fadeIn 0.5s ease-in-out forwards;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .fade-in-slide-up {
    animation: fadeInSlideUp 0.5s ease-out forwards;
    opacity: 0;
  }

  @keyframes fadeInSlideUp {
    from {
      opacity: 0;
      transform: translateY(15px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Drag and Drop */
  #draggable_cliente {
    cursor: grab;
  }

  #draggable_cliente.dragging {
    opacity: 0.6;
    cursor: grabbing;
    border: 2px dashed #0d6efd;
  }

  #drop_zone {
    transition: all 0.2s ease-in-out;
    border: 2px dashed transparent;
  }

  #drop_zone.drag-over-active {
    border-color: #0d6efd;
    background-color: #f0f8ff;
  }

  #drop_zone.drag-over-target {
    transform: scale(1.01);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  }

  /* Skeleton Loading */
  .skeleton {
    animation: skeleton-loading 1s linear infinite alternate;
  }

  @keyframes skeleton-loading {
    0% {
      background-color: hsl(200, 20%, 85%);
    }
    100% {
      background-color: hsl(200, 20%, 95%);
    }
  }

  .skeleton-text {
    width: 100%;
    height: 1rem;
    margin-bottom: 0.5rem;
    border-radius: 0.25rem;
  }

  .skeleton-text:last-child {
    width: 80%;
  }
</style>
{% endblock %} {% block scripts %} {{ super() }}
<script src="https://unpkg.com/imask"></script>

<script nonce="{{ csp_nonce() }}">
  document.addEventListener('DOMContentLoaded', function () {
    // --- ELEMENTOS DO DOM ---
    const cpfInput = document.getElementById('cpf_busca');
    const dadosClienteArea = document.getElementById('dados_cliente_area');
    const dropZone = document.getElementById('drop_zone');
    const dropPlaceholder = document.getElementById('drop_placeholder');
    const peticaoFields = document.getElementById('peticao_fields');
    const peticaoForm = document.getElementById('peticao_form');
    const toastElement = document.getElementById('appToast');
    const previewPanel = document.getElementById('preview_panel');
    const togglePreviewBtn = document.getElementById('toggle_preview');
    const closePreviewBtn = document.getElementById('close_preview');
    const previewContent = document.getElementById('preview_content');
    const previewLoading = document.getElementById('preview_loading');
    const buscaClienteSection = document.getElementById(
      'busca_cliente_section'
    );
    const modoBuscar = document.getElementById('modo_buscar');
    const modoNovo = document.getElementById('modo_novo');

    const toast = new bootstrap.Toast(toastElement);

    // --- VARIÁVEIS DE ESTADO ---
    let clienteData = null;
    let previewTimeout = null;

    // --- INICIALIZAÇÃO DA MÁSCARA DO CPF ---
    const cpfMask = IMask(cpfInput, {
      mask: '000.000.000-00',
    });

    // --- FUNÇÕES HELPER ---
    const debounce = (func, delay) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    };

    const showToast = (title, message, type = 'success') => {
      const toastHeader = toastElement.querySelector('.toast-header');
      toastHeader.classList.remove(
        'bg-success',
        'bg-danger',
        'bg-warning',
        'bg-info'
      );
      toastHeader.classList.add(`bg-${type}`);

      document.getElementById('toastTitle').textContent = title;
      document.getElementById('toastBody').textContent = message;
      toast.show();
    };

    // --- CONTROLE DE MODO CLIENTE ---
    function handleModoClienteChange() {
      const isModoBuscar = modoBuscar.checked;

      if (isModoBuscar) {
        // Modo buscar CPF
        buscaClienteSection.classList.remove('d-none');
        dropPlaceholder.classList.remove('d-none');
        peticaoFields.classList.add('d-none');
        clienteData = null;
        resetForm();
      } else {
        // Modo novo cliente - mostrar campos para preenchimento manual
        buscaClienteSection.classList.add('d-none');
        dropPlaceholder.classList.add('d-none');
        peticaoFields.classList.remove('d-none');

        // Limpar dados do cliente anterior
        clienteData = null;
        peticaoForm.querySelector('[name="cliente_id"]').value = '';

        // Remover alerta de cliente carregado se existir
        const clienteAlert = document.getElementById('cliente_alert');
        if (clienteAlert) {
          clienteAlert.classList.add('d-none');
        }

        // Limpar formulário
        peticaoForm.reset();

        showToast(
          'Info',
          'Modo novo cliente ativado. Preencha os dados manualmente.',
          'info'
        );
      }
    }

    modoBuscar.addEventListener('change', handleModoClienteChange);
    modoNovo.addEventListener('change', handleModoClienteChange);

    // --- PREVIEW FUNCTIONS ---
    const generatePreview = debounce(() => {
      if (!previewPanel.classList.contains('d-none')) {
        const formData = new FormData(peticaoForm);

        previewLoading.classList.remove('d-none');
        previewContent.classList.add('d-none');

        fetch('/peticionador/api/preview-document', {
          method: 'POST',
          body: formData,
        })
          .then(response => response.text())
          .then(html => {
            previewContent.innerHTML = html;
            previewLoading.classList.add('d-none');
            previewContent.classList.remove('d-none');
          })
          .catch(error => {
            console.error('Erro ao gerar preview:', error);
            previewLoading.classList.add('d-none');
            previewContent.innerHTML =
              '<div class="alert alert-danger">Erro ao gerar preview</div>';
            previewContent.classList.remove('d-none');
          });
      }
    }, 700);

    // --- TOGGLE PREVIEW ---
    togglePreviewBtn.addEventListener('click', () => {
      if (previewPanel.classList.contains('d-none')) {
        previewPanel.classList.remove('d-none');
        togglePreviewBtn.innerHTML =
          '<i class="fas fa-eye-slash me-1"></i>Ocultar';
        generatePreview();
      } else {
        previewPanel.classList.add('d-none');
        togglePreviewBtn.innerHTML = '<i class="fas fa-eye me-1"></i>Preview';
      }
    });

    closePreviewBtn.addEventListener('click', () => {
      previewPanel.classList.add('d-none');
      togglePreviewBtn.innerHTML = '<i class="fas fa-eye me-1"></i>Preview';
    });

    // --- BUSCA DE CLIENTE ---
    const searchClient = debounce(async cpf => {
      if (!cpf || cpf.length < 11) {
        dadosClienteArea.innerHTML = `
          <div class="text-center text-muted py-3">
            <i class="fas fa-keyboard fa-2x mb-2"></i>
            <p class="mb-0">Digite um CPF válido...</p>
          </div>
        `;
        return;
      }

      dadosClienteArea.innerHTML = `
        <div class="skeleton">
          <div class="skeleton-text"></div>
          <div class="skeleton-text"></div>
          <div class="skeleton-text"></div>
        </div>
      `;

      try {
        const response = await fetch(
          `/peticionador/api/clientes/busca_cpf?cpf=${cpf}`
        );
        const data = await response.json();

        if (data.success) {
          clienteData = data.cliente;
          renderClientCard(data.cliente);
        } else {
          dadosClienteArea.innerHTML = `
            <div class="text-center text-muted py-3">
              <i class="fas fa-user-times fa-2x mb-2"></i>
              <p class="mb-0">Cliente não encontrado</p>
              <small>CPF: ${cpf}</small>
            </div>
          `;
        }
      } catch (error) {
        console.error('Erro na busca:', error);
        dadosClienteArea.innerHTML = `
          <div class="text-center text-danger py-3">
            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
            <p class="mb-0">Erro na busca</p>
          </div>
        `;
      }
    }, 500);

    cpfInput.addEventListener('input', e => {
      const cpf = e.target.value.replace(/\D/g, '');
      searchClient(cpf);
    });

    // --- RENDER CLIENT CARD ---
    function renderClientCard(cliente) {
      const nomeCompleto =
        `${cliente.primeiro_nome || ''} ${cliente.sobrenome || ''}`.trim();

      dadosClienteArea.innerHTML = `
        <div id="draggable_cliente" class="card border-primary" draggable="true">
          <div class="card-body p-3">
            <div class="d-flex align-items-center mb-2">
              <i class="fas fa-user-circle fa-2x text-primary me-3"></i>
              <div>
                <h6 class="mb-0">${nomeCompleto || 'Nome não informado'}</h6>
                <small class="text-muted">CPF: ${cliente.cpf || 'Não informado'}</small>
              </div>
            </div>
            <div class="small text-muted">
              <div><i class="fas fa-map-marker-alt me-1"></i>${cliente.endereco_cidade || 'Cidade não informada'}</div>
              <div><i class="fas fa-phone me-1"></i>${cliente.telefone_celular || 'Telefone não informado'}</div>
            </div>
            <div class="mt-2">
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="showClientDetails('${cliente.id}')">
                <i class="fas fa-eye me-1"></i>Ver Detalhes
              </button>
            </div>
          </div>
        </div>
      `;

      setupDragAndDrop();
    }

    // --- DRAG AND DROP ---
    function setupDragAndDrop() {
      const draggableCliente = document.getElementById('draggable_cliente');
      if (!draggableCliente) return;

      draggableCliente.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', JSON.stringify(clienteData));
        draggableCliente.classList.add('dragging');
      });

      draggableCliente.addEventListener('dragend', () => {
        draggableCliente.classList.remove('dragging');
      });
    }

    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('drag-over-active');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over-active');
    });

    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over-active');

      try {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        loadClientData(data);
      } catch (error) {
        console.error('Erro ao processar dados do cliente:', error);
      }
    });

    // --- LOAD CLIENT DATA ---
    function loadClientData(cliente) {
      clienteData = cliente;

      // Atualizar interface
      dropPlaceholder.classList.add('d-none');
      peticaoFields.classList.remove('d-none');

      const nomeCompleto =
        `${cliente.primeiro_nome || ''} ${cliente.sobrenome || ''}`.trim();
      document.getElementById('cliente_nome_form').textContent =
        nomeCompleto || 'Cliente Carregado!';
      document.getElementById('cliente_cpf_form').textContent =
        `CPF: ${cliente.cpf || 'Não informado'}`;

      peticaoForm.querySelector('[name="cliente_id"]').value = cliente.id;

      showToast('Sucesso', 'Cliente carregado com sucesso!', 'success');

      // Gerar preview se estiver ativo
      generatePreview();
    }

    // --- RESET FORM ---
    function resetForm() {
      peticaoForm.reset();
      peticaoForm.querySelector('[name="cliente_id"]').value = '';
      dropPlaceholder.classList.remove('d-none');
      peticaoFields.classList.add('d-none');
    }

    // --- FORM INPUT LISTENERS ---
    peticaoForm.addEventListener('input', () => {
      generatePreview();
    });

    // --- RESET CLIENTE ---
    document
      .getElementById('btn_reset_cliente')
      .addEventListener('click', () => {
        resetForm();
        clienteData = null;
        showToast('Info', 'Cliente removido do formulário', 'info');
      });

    // --- CANCELAR ---
    document
      .getElementById('btn_cancelar_peticao')
      .addEventListener('click', e => {
        e.preventDefault();
        if (
          confirm(
            'Tem certeza que deseja cancelar? Todos os dados serão perdidos.'
          )
        ) {
          window.location.href = '/modelos';
        }
      });

    // --- GLOBAL FUNCTIONS ---
    window.showClientDetails = function (clienteId) {
      fetch(`/peticionador/api/clientes/${clienteId}/detalhes`)
        .then(response => response.text())
        .then(html => {
          document.getElementById('clienteModalBody').innerHTML = html;
          new bootstrap.Modal(
            document.getElementById('clienteDetailModal')
          ).show();
        })
        .catch(error => {
          console.error('Erro ao carregar detalhes:', error);
          showToast('Erro', 'Erro ao carregar detalhes do cliente', 'danger');
        });
    };

    // --- INITIALIZATION ---
    handleModoClienteChange();
  });
</script>
{% endblock %}
