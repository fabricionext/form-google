{% extends '_base_peticionador.html' %}
{% from '_macros_peticionador.html' import render_flash_messages, render_responsive_table %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <h1 class="mt-4">{{ title }}</h1>
  <ol class="breadcrumb mb-4">
    <li class="breadcrumb-item">
      <a href="{{ url_for('peticionador.index') }}">Dashboard</a>
    </li>
    <li class="breadcrumb-item active">{{ title }}</li>
  </ol>

  <div class="card mb-4">
    <div class="card-header">
      <i class="fas fa-users me-1"></i>
      Lista de Clientes Cadastrados
      <a
        href="{{ url_for('peticionador.adicionar_cliente') }}"
        class="btn btn-primary btn-sm float-end"
      >
        <i class="fas fa-plus me-1"></i> Adicionar Novo Cliente
      </a>
    </div>
    <div class="card-body">
      {{ render_flash_messages() }}
      
      {% if clientes %}
        {% set table_headers = ['Nome/Razão Social', 'CPF/CNPJ', 'Email', 'Telefone', 'Tipo'] %}
        {% set table_fields = ['nome', 'documento', 'email', 'telefone', 'tipo_pessoa'] %}
        {% set table_actions = [
          {
            'label': 'Ver',
            'icon': 'fas fa-eye',
            'url': '/peticionador/clientes/{id}/detalhes',
            'style': 'outline-primary',
            'title': 'Ver detalhes do cliente'
          },
          {
            'label': 'Editar', 
            'icon': 'fas fa-edit',
            'url': '/peticionador/clientes/{id}/editar',
            'style': 'outline-secondary',
            'title': 'Editar cliente'
          }
        ] %}
        
        {# Preprocessar dados para a tabela #}
        {% set processed_clients = [] %}
        {% for cliente in clientes %}
          {% set processed_client = {
            'id': cliente.id,
            'nome': cliente.nome_completo_formatado or (cliente.primeiro_nome + ' ' + (cliente.sobrenome or '') if cliente.primeiro_nome else cliente.razao_social or 'N/A'),
            'documento': cliente.cpf if cliente.tipo_pessoa.name == 'FISICA' else cliente.cnpj,
            'email': cliente.email or 'N/A',
            'telefone': cliente.telefone_celular or cliente.telefone_outro or 'N/A',
            'tipo_pessoa': 'Pessoa Física' if cliente.tipo_pessoa.name == 'FISICA' else 'Pessoa Jurídica'
          } %}
          {% set _ = processed_clients.append(processed_client) %}
        {% endfor %}
        
        {{ render_responsive_table(processed_clients, table_headers, table_fields, table_actions) }}
      {% else %}
        <div class="alert alert-info" role="alert">
          <i class="fas fa-info-circle"></i>
          Nenhum cliente cadastrado ainda.
          <a href="{{ url_for('peticionador.adicionar_cliente') }}"
          >Clique aqui para adicionar o primeiro.</a
        >
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal de Confirmação de Exclusão (reutilizar o existente se houver ou adaptar) -->
<!-- Se já existir um modal de confirmação em _base_peticionador.html ou similar, este pode não ser necessário -->
<div
  class="modal fade"
  id="confirmDeleteModal"
  tabindex="-1"
  aria-labelledby="confirmDeleteModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">
          Confirmar Exclusão
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja excluir o cliente
        <strong id="itemName"></strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <a href="#" id="deleteConfirmButton" class="btn btn-danger">Excluir</a>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts_extra %} {{ super() }}
<!-- Se estiver usando DataTables e o script de inicialização não estiver no _base_peticionador.html -->
<!-- <script>
    window.addEventListener('DOMContentLoaded', event => {
        const datatablesSimple = document.getElementById('datatablesSimple');
        if (datatablesSimple) {
            new simpleDatatables.DataTable(datatablesSimple);
        }
    });
</script> -->

<!-- Script para o modal de confirmação (se não estiver global) -->
<script nonce="{{ csp_nonce() }}">
  document.addEventListener('DOMContentLoaded', function () {
    var confirmDeleteModal = document.getElementById('confirmDeleteModal');
    if (confirmDeleteModal) {
      confirmDeleteModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var deleteUrl = button.getAttribute('data-delete-url');
        var itemName = button.getAttribute('data-item-name');

        var modalTitle = confirmDeleteModal.querySelector('.modal-title');
        var modalBodyStrong =
          confirmDeleteModal.querySelector('.modal-body strong');
        var deleteConfirmButton = confirmDeleteModal.querySelector(
          '#deleteConfirmButton'
        );

        modalBodyStrong.textContent = itemName;
        deleteConfirmButton.setAttribute('href', deleteUrl);
      });
    }
  });
</script>
{% endblock %}
