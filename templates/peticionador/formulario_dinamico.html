{% extends "_base_peticionador.html" %} {% from "peticionador/_form_macros.html"
import render_field %} {% block title %}{{ form_gerado.nome }} - {{ modelo.nome
}}{% endblock %} {% block head_extra %}
<!-- Interact.js para drag & drop moderno -->
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<!-- Alpine.js para reatividade declarativa -->
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<!-- HTMX para carregamento din√¢mico -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<!-- Fuse.js para busca fuzzy -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
<!-- M√°scaras de input espec√≠ficas do formul√°rio din√¢mico -->
<script src="{{ url_for('peticionador.static', filename='js/formulario_dinamico_masks.js') }}"></script>
<!-- Sistema de valida√ß√µes em tempo real -->
<!-- Scripts com cache buster para for√ßar reload -->
<script src="{{ url_for('peticionador.static', filename='js/form_validators.js') }}?v=20250126004"></script>
<!-- Aplica√ß√£o refatorada e modular -->
<script src="{{ url_for('peticionador.static', filename='js/formulario_app_refatorado.js') }}?v=20250626004"></script>
<!-- SortableJS para drag-and-drop avan√ßado -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<!-- Sistema de preenchimento autom√°tico por CPF e Nome -->
<script src="{{ url_for('peticionador.static', filename='js/auto_fill_cliente.js') }}?v=20250626001"></script>

<!-- Sistema de detec√ß√£o de erros e reload for√ßado -->
<script>
  window.addEventListener('error', function (e) {
    if (
      e.message.includes('Cannot set properties of undefined') &&
      e.filename.includes('formulario_app_refatorado.js')
    ) {
      console.warn(
        'üîÑ Detectado erro de cache - for√ßando reload dos scripts...'
      );

      // Recarregar script principal com novo timestamp
      const oldScript = document.querySelector(
        'script[src*="formulario_app_refatorado.js"]'
      );
      if (oldScript) {
        oldScript.remove();

        const newScript = document.createElement('script');
        newScript.src =
          "{{ url_for('peticionador.static', filename='js/formulario_app_refatorado.js') }}?v=" +
          Date.now();
        newScript.onload = function () {
          console.log('‚úÖ Script recarregado com sucesso');
          // Reinicializar Alpine.js se necess√°rio
          if (window.Alpine && window.FormularioAppClass) {
            location.reload(); // Reload completo para garantir estado limpo
          }
        };
        document.head.appendChild(newScript);
      }
    }
  });

  // Debug adicional: verificar formul√°rio ap√≥s carregamento
  document.addEventListener('DOMContentLoaded', function () {
    // Fun√ß√£o global para limpar rascunhos manualmente
    window.clearAllDrafts = function () {
      let removed = 0;
      const keysToRemove = [];

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('draft_')) {
          keysToRemove.push(key);
        }
      }

      keysToRemove.forEach(key => {
        localStorage.removeItem(key);
        removed++;
      });

      console.log(`üßπ ${removed} rascunhos removidos do localStorage`);
      alert(`${removed} rascunhos removidos com sucesso!`);
    };

    setTimeout(function () {
      const form = document.getElementById('peticao_form');
      if (form) {
        const allFields = form.querySelectorAll('[name]');
        console.log('üîç TOTAL DE CAMPOS NO FORMUL√ÅRIO:', allFields.length);
        console.log(
          'üîç AMOSTRA DE CAMPOS:',
          Array.from(allFields)
            .slice(0, 10)
            .map(f => ({
              name: f.name,
              type: f.type,
              value: f.value,
              id: f.id,
            }))
        );

        // Testar preenchimento manual
        const testField = form.querySelector('[name="autor_1_nome"]');
        if (testField) {
          console.log('‚úÖ Campo autor_1_nome encontrado:', testField);
          testField.value = 'TESTE MANUAL';
          console.log('‚úÖ Valor definido:', testField.value);
        } else {
          console.warn('‚ö†Ô∏è Campo autor_1_nome N√ÉO encontrado');
          const autorFields = Array.from(allFields).filter(f =>
            f.name.includes('autor_1')
          );
          console.log(
            'üîç Campos de autor_1 dispon√≠veis:',
            autorFields.map(f => f.name)
          );
        }

        // Informar sobre fun√ß√£o de limpeza
        console.log(
          'üí° Para limpar todos os rascunhos, execute: clearAllDrafts()'
        );
      } else {
        console.error('‚ùå Formul√°rio #peticao_form n√£o encontrado!');
      }
    }, 2000);
  });
</script>

<style>
  :root {
    --color-primary: #4e73df;
    --color-secondary: #6c757d;
    --color-success: #28a745;
    --color-info: #17a2b8;
    --color-warning: #ffc107;
    --color-danger: #dc3545;
    --border-radius: 0.375rem;
    --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    --shadow-md: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15);
  }

  .form-grid {
    display: grid;
    gap: 2rem;
  }

  .form-section {
    background: #fff;
    border: 1px solid #e3e6f0;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
  }

  .form-section:hover {
    box-shadow: var(--shadow-md);
  }

  .section-header {
    background: linear-gradient(45deg, var(--color-primary), #224abe);
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .section-header h6 {
    margin: 0;
    font-weight: 600;
  }

  .section-content {
    padding: 1.5rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
  }

  .card-search {
    position: sticky;
    top: 20px;
    z-index: 100;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
  }

  /* Interact.js Drag and Drop Styles */
  .drag-zone {
    border: 2px dashed #d1ecf1;
    border-radius: var(--border-radius);
    background: rgba(209, 236, 241, 0.3);
    padding: 3rem 2rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
  }

  .drag-zone.drop-active {
    border-color: var(--color-info);
    background: rgba(23, 162, 184, 0.1);
    transform: scale(1.02);
    box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
  }

  .drag-zone.drop-target {
    border-color: var(--color-success);
    background: rgba(40, 167, 69, 0.1);
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
  }

  /* Cards dragg√°veis com Interact.js */
  .draggable-card {
    border: 1px solid #dee2e6;
    border-radius: var(--border-radius);
    background: white;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
    cursor: grab;
    position: relative;
    user-select: none;
    touch-action: none;
  }

  .draggable-card:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border-color: var(--color-primary);
    transform: translateY(-2px);
  }

  .draggable-card.dragging {
    opacity: 0.7;
    transform: rotate(3deg) scale(1.05);
    cursor: grabbing;
    z-index: 1000;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }

  .client-card {
    border: 1px solid var(--color-success);
    background: linear-gradient(45deg, var(--color-success), #20c997);
    color: white;
  }

  .authority-card {
    border: 1px solid var(--color-info);
    background: white;
  }

  /* Drop zones para autoridades */
  .authority-drop-zone {
    border: 2px dashed #e9ecef;
    border-radius: var(--border-radius);
    padding: 1rem;
    transition: all 0.3s ease;
    margin-bottom: 1rem;
    position: relative;
    min-height: 80px;
  }

  .authority-drop-zone.drop-active {
    border-color: var(--color-primary);
    background-color: rgba(78, 115, 223, 0.05);
  }

  .authority-drop-zone.drop-target {
    border-color: var(--color-success);
    background-color: rgba(40, 167, 69, 0.1);
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
  }

  .authority-drop-zone.filled {
    border-color: var(--color-success);
    background: linear-gradient(
      45deg,
      rgba(40, 167, 69, 0.1),
      rgba(32, 201, 151, 0.1)
    );
  }

  /* Status indicators */
  .status-indicator {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ccc;
    transition: all 0.3s ease;
  }

  .status-indicator.filled {
    background: var(--color-success);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  /* Alpine.js transitions */
  [x-cloak] {
    display: none !important;
  }

  .slide-fade-enter {
    transition: all 0.3s ease-out;
    transform: translateY(0);
    opacity: 1;
  }

  /* === Alpine Transition ‚Äì Novo esquema === */
  .transition-enter {
    transition: all 0.3s ease-out;
  }
  .transition-enter-start {
    opacity: 0;
    transform: translateY(-10px);
  }
  .transition-enter-end {
    opacity: 1;
    transform: translateY(0);
  }

  /* Estilos de valida√ß√£o em tempo real */
  .form-control.is-valid {
    border-color: var(--color-success);
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
  }

  .form-control.is-invalid {
    border-color: var(--color-danger);
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
  }

  .invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: var(--color-danger);
  }

  .valid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: var(--color-success);
  }

  /* Indicador de altera√ß√µes n√£o salvas */
  #unsaved-indicator {
    animation: fadeInUp 0.3s ease;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translate(-50%, -20px);
    }
    to {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  }

  /* Melhorias na UX dos campos */
  .form-control:focus {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
  }

  .form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .required-field::after {
    content: ' *';
    color: var(--color-danger);
  }

  /* Responsividade */
  @media (max-width: 768px) {
    .form-row {
      grid-template-columns: 1fr;
    }
    .drag-zone {
      padding: 2rem 1rem;
    }
    .section-header {
      padding: 0.75rem 1rem;
    }
    .section-content {
      padding: 1rem;
    }
  }

  /* Drop zones para se√ß√µes de autor - Unificadas */
  .autor-drop-zone-wrapper {
    position: relative;
    transition: all 0.3s ease;
    cursor: pointer;
    display: grid;
    gap: 2rem;
    border: 2px dashed transparent;
    border-radius: var(--border-radius);
    padding: 1rem;
    margin-bottom: 2rem;
  }

  .autor-drop-zone-wrapper.drop-active {
    border: 2px dashed var(--color-success) !important;
    background-color: rgba(40, 167, 69, 0.05);
    transform: scale(1.02);
  }

  .autor-drop-zone-wrapper.drop-target {
    border: 2px solid var(--color-success) !important;
    background-color: rgba(40, 167, 69, 0.1);
    box-shadow:
      0 0 0 3px rgba(40, 167, 69, 0.2),
      0 8px 25px rgba(40, 167, 69, 0.3);
  }

  .autor-drop-zone-wrapper::before {
    content: 'üìÅ Arraste um cliente aqui para preencher';
    position: absolute;
    top: -8px;
    right: 10px;
    background: var(--color-info);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 10;
  }

  .autor-drop-zone-wrapper.drop-active::before,
  .autor-drop-zone-wrapper.drop-target::before {
    opacity: 1;
    background: var(--color-success);
    content: '‚ú® Solte aqui para preencher este autor';
  }

  /* === SISTEMA DE ORGANIZA√á√ÉO DE CAMPOS === */
  .field-organizer {
    position: fixed;
    top: 50%;
    left: 20px;
    transform: translateY(-50%);
    z-index: 1200;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    padding: 1rem;
    width: 280px;
    max-height: 80vh;
    overflow-y: auto;
  }

  .field-organizer.hidden {
    display: none;
  }

  .field-item {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    cursor: grab;
    transition: all 0.2s ease;
    user-select: none;
  }

  .field-item:hover {
    background: #e9ecef;
    border-color: var(--color-primary);
  }

  .field-item.dragging {
    opacity: 0.5;
    cursor: grabbing;
  }

  .field-item.placeholder {
    background: rgba(78, 115, 223, 0.1);
    border: 2px dashed var(--color-primary);
    height: 40px;
  }

  .organize-toggle {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1300;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
  }

  .organize-toggle:hover {
    background: var(--color-secondary);
    transform: scale(1.1);
  }

  .carousel-control-prev-icon,
  .carousel-control-next-icon {
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
  }
</style>
{% endblock %} {% block content %}
<div
  class="container-fluid mt-4"
  x-data="formularioApp({{ modelo|safe_json|tojson }}, {{ documento_gerado|tojson }}, {{ link_documento|tojson }})"
  x-cloak
>
  <!-- Bot√£o para alternar organizador -->
  <button
    type="button"
    class="organize-toggle"
    @click="toggleOrganizer()"
    :title="organizerVisible ? 'Fechar Organizador' : 'Organizar Campos'"
  >
    <i class="fas" :class="organizerVisible ? 'fa-times' : 'fa-cog'"></i>
  </button>

  <!-- Painel Organizador de Campos -->
  <div
    class="field-organizer"
    :class="{ 'hidden': !organizerVisible }"
    x-show="organizerVisible"
    x-transition
  >
    <h6 class="mb-3"><i class="fas fa-sort me-2"></i>Organizar Campos</h6>
    <p class="small text-muted mb-3">
      Arraste para reordenar os campos do formul√°rio
    </p>

    <div id="field-organizer-list">
      <template x-for="section in fieldSections" :key="section.id">
        <div class="mb-3">
          <h6 class="text-primary mb-2" x-text="section.title"></h6>
          <div :data-section="section.id" class="sortable-section">
            <template x-for="field in section.fields" :key="field.name">
              <div
                class="field-item"
                :data-field="field.name"
                x-text="field.label"
              ></div>
            </template>
          </div>
        </div>
      </template>
    </div>

    <div class="mt-3 pt-3 border-top">
      <button
        type="button"
        @click="resetFieldOrder()"
        class="btn btn-sm btn-outline-secondary w-100"
      >
        <i class="fas fa-undo me-1"></i>Restaurar Ordem Original
      </button>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="text-primary mb-1">{{ form_gerado.nome }}</h2>
      <p class="text-muted mb-0">
        Baseado no modelo: <strong>{{ modelo_nome }}</strong>
      </p>
    </div>
    <div class="d-flex gap-2">
      <button
        type="button"
        @click="togglePreview()"
        class="btn btn-outline-info"
      >
        <i class="fas fa-eye me-1"></i>Preview
      </button>
      <button
        type="button"
        @click="saveDraft()"
        class="btn btn-outline-secondary"
        :disabled="saving"
      >
        <i class="fas fa-save me-1" :class="{ 'fa-spin': saving }"></i>
        <span x-text="saving ? 'Salvando...' : 'Salvar Rascunho'"></span>
      </button>
    </div>
  </div>

  <div class="row g-4">
    <!-- Sidebar com Buscas -->
    <div class="col-lg-3">
      <!-- Busca de Cliente -->
      <div class="card card-search shadow-sm mb-4">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0">
            <i class="fas fa-user-search me-2"></i>Buscar Cliente
          </h6>
        </div>
        <div class="card-body">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-id-card"></i></span>
            <input
              type="text"
              x-model="cpfBusca"
              @input.debounce.500ms="searchCliente()"
              class="form-control"
              placeholder="Digite o CPF..."
              autocomplete="off"
            />
          </div>
          <div class="mt-2">
            <small class="text-muted"
              >Digite o CPF para buscar cliente existente</small
            >
          </div>
        </div>
        <div class="card-footer p-0">
          <div x-show="clienteLoading" class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-2 text-primary"></i>
            <p class="mb-0">Buscando cliente...</p>
          </div>

          <div x-show="clienteEncontrado && !clienteLoading" x-transition>
            <div
              class="draggable-card client-card p-3"
              data-type="cliente"
              :data-cliente="JSON.stringify(cliente)"
              role="button"
              tabindex="0"
            >
              <div class="d-flex align-items-center">
                <i class="fas fa-grip-vertical me-2" aria-hidden="true"></i>
                <i class="fas fa-user-circle fa-2x me-3" aria-hidden="true"></i>
                <div class="flex-grow-1">
                  <h6 class="mb-1" x-text="clienteNomeCompleto"></h6>
                  <small
                    class="opacity-75"
                    x-text="'CPF: ' + (cliente && cliente.cpf || 'N√£o informado')"
                  ></small>
                </div>
                <div class="status-indicator" aria-hidden="true"></div>
              </div>
            </div>
          </div>

          <div
            x-show="!clienteLoading && !clienteEncontrado && !clienteErro"
            class="text-center py-4 text-muted"
          >
            <i class="fas fa-search fa-2x mb-2"></i>
            <p class="mb-0">Digite um CPF para buscar</p>
          </div>

          <div
            x-show="clienteErro"
            x-transition
            class="text-center py-4 text-warning"
          >
            <i class="fas fa-user-times fa-2x mb-2"></i>
            <p class="mb-0">Cliente n√£o encontrado</p>
          </div>
        </div>
      </div>

      <!-- Busca de Autoridades -->
      <div class="card card-search shadow-sm">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0">
            <i class="fas fa-building-shield me-2"></i>Autoridades de Tr√¢nsito
          </h6>
        </div>
        <div class="card-body">
          <div class="position-relative">
            <div class="input-group">
              <span class="input-group-text"
                ><i class="fas fa-search"></i
              ></span>
              <input
                type="text"
                x-model="autoridadeBusca"
                @input.debounce.300ms="searchAutoridades()"
                class="form-control"
                placeholder="Digite o nome da autoridade..."
                autocomplete="off"
              />
            </div>

            <div
              x-show="autoridadeSugestoes.length > 0"
              x-transition
              class="position-absolute w-100 bg-white border border-top-0 rounded-bottom shadow-sm"
              style="
                top: 100%;
                z-index: 1000;
                max-height: 200px;
                overflow-y: auto;
              "
            >
              <template
                x-for="autoridade in autoridadeSugestoes"
                :key="autoridade.id"
              >
                <div
                  @click="selectAutoridade(autoridade)"
                  class="p-2 border-bottom cursor-pointer hover:bg-light"
                >
                  <div class="d-flex align-items-center">
                    <i class="fas fa-building me-2 text-primary"></i>
                    <div>
                      <div class="fw-bold" x-text="autoridade.nome"></div>
                      <small
                        class="text-muted"
                        x-text="(autoridade.cidade || '') + ' - ' + (autoridade.estado || '')"
                      ></small>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <div class="mt-2">
            <small class="text-muted"
              >Digite para buscar autoridades cadastradas</small
            >
          </div>
        </div>
        <div class="card-footer p-0">
          <div x-show="autoridadeLoading" class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-2 text-primary"></i>
            <p class="mb-0">Buscando autoridades...</p>
          </div>

          <div
            x-show="autoridadeSelecionada && !autoridadeLoading"
            x-transition
          >
            <div
              class="draggable-card authority-card p-3"
              data-type="autoridade"
              :data-autoridade="JSON.stringify(autoridadeSelecionada)"
              role="button"
              tabindex="0"
            >
              <div class="d-flex align-items-center">
                <i
                  class="fas fa-grip-vertical me-2 text-muted"
                  aria-hidden="true"
                ></i>
                <i
                  class="fas fa-building fa-2x me-3 text-primary"
                  aria-hidden="true"
                ></i>
                <div class="flex-grow-1">
                  <h6
                    class="mb-1"
                    x-text="autoridadeSelecionada && autoridadeSelecionada.nome || 'Nome n√£o informado'"
                  ></h6>
                  <small
                    class="text-muted"
                    x-text="(autoridadeSelecionada && autoridadeSelecionada.cidade || 'Cidade n√£o informada') + ' - ' + (autoridadeSelecionada && autoridadeSelecionada.estado || 'UF')"
                  ></small>
                  <br /><small
                    class="text-muted"
                    x-text="'CNPJ: ' + (autoridadeSelecionada && autoridadeSelecionada.cnpj || 'N√£o informado')"
                  ></small>
                </div>
                <div class="status-indicator" aria-hidden="true"></div>
              </div>
            </div>
          </div>

          <div
            x-show="!autoridadeLoading && !autoridadeSelecionada"
            class="text-center py-4 text-muted"
          >
            <i class="fas fa-building fa-2x mb-2"></i>
            <p class="mb-0">Digite para buscar autoridades</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Formul√°rio Principal -->
    <div class="col-lg-9">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="fas fa-file-alt me-2"></i>Formul√°rio de Dados
          </h5>
        </div>
        <div class="card-body">
          <form
            method="POST"
            id="peticao_form"
            @submit.prevent="submitForm()"
            novalidate
          >
            {{ form.hidden_tag() }}
            <input type="hidden" name="modelo_id" value="{{ modelo.id }}" />
            <input type="hidden" name="cliente_id" x-model="clienteId" />

            <!-- Zona de Drop Inicial -->
            <div
              x-show="!clienteCarregado"
              x-transition.duration.300ms
              class="drag-zone"
              id="drop_placeholder"
            >
              <i class="fas fa-mouse-pointer fa-4x mb-3 text-info"></i>
              <h5 class="text-info">Arraste o card do cliente aqui</h5>
              <p class="text-muted mb-0">
                para preencher os dados automaticamente
              </p>
            </div>

            <!-- Campos do Formul√°rio -->
            <div x-show="clienteCarregado" x-transition.duration.500ms>
              <!-- Alert do Cliente Carregado -->
              <div
                class="alert alert-success d-flex justify-content-between align-items-center mb-4"
              >
                <div class="d-flex align-items-center">
                  <i class="fas fa-user-check fa-2x me-3"></i>
                  <div>
                    <h6
                      class="alert-heading mb-0"
                      x-text="'Cliente: ' + clienteNomeCompleto"
                    ></h6>
                    <small
                      x-text="'CPF: ' + (cliente && cliente.cpf || 'N√£o informado')"
                    ></small>
                  </div>
                </div>
                <button
                  type="button"
                  @click="resetCliente()"
                  class="btn-close"
                  title="Trocar Cliente"
                ></button>
              </div>

              <!-- Grid de Campos Organizados -->
              <div class="form-grid">
                <!-- SE√á√ÉO DE AUTORES EM CARROSSEL -->
                {% if campo_grupos.autores %}
                <div
                  id="autoresCarousel"
                  class="carousel slide"
                  data-bs-interval="false"
                >
                  <div class="carousel-inner">
                    {% for autor_num, autor_campos in
                    campo_grupos.autores.items()|sort %}
                    <div
                      class="carousel-item {% if loop.first %}active{% endif %}"
                    >
                      <div class="autor-drop-zone-wrapper">
                        <!-- Dados do Autor -->
                        {% if autor_campos.dados %}
                        <div class="form-section">
                          <div class="section-header">
                            <h6>
                              <i class="fas fa-user me-2"></i>
                              A{{ autor_num }}. Dados do Autor {{ autor_num }}
                            </h6>
                          </div>
                          <div class="section-content">
                            <div class="form-row">
                              {% for field in form if field.name in
                              autor_campos.dados %}
                              <div class="form-col">
                                {{ render_field(field) }}
                              </div>
                              {% endfor %}
                            </div>
                          </div>
                        </div>
                        {% endif %}

                        <!-- Endere√ßo do Autor -->
                        {% if autor_campos.endereco %}
                        <div class="form-section mt-3">
                          <div class="section-header">
                            <h6>
                              <i class="fas fa-map-marker-alt me-2"></i>
                              A{{ autor_num }}E. Endere√ßo do Autor {{ autor_num
                              }}
                            </h6>
                          </div>
                          <div class="section-content">
                            <div class="form-row">
                              {% for field in form if field.name in
                              autor_campos.endereco %}
                              <div class="form-col">
                                {{ render_field(field) }}
                              </div>
                              {% endfor %}
                            </div>
                          </div>
                        </div>
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                  <button
                    class="carousel-control-prev"
                    type="button"
                    data-bs-target="#autoresCarousel"
                    data-bs-slide="prev"
                  >
                    <span
                      class="carousel-control-prev-icon"
                      aria-hidden="true"
                    ></span>
                    <span class="visually-hidden">Anterior</span>
                  </button>
                  <button
                    class="carousel-control-next"
                    type="button"
                    data-bs-target="#autoresCarousel"
                    data-bs-slide="next"
                  >
                    <span
                      class="carousel-control-next-icon"
                      aria-hidden="true"
                    ></span>
                    <span class="visually-hidden">Pr√≥ximo</span>
                  </button>
                </div>
                {% endif %}

                <!-- Dados do Cliente (fallback para campos sem numera√ß√£o) -->
                {% if campo_grupos.cliente %}
                <div class="form-section">
                  <div class="section-header">
                    <h6>
                      <i class="fas fa-user-circle me-2"></i>B. Dados do Cliente
                    </h6>
                    <span class="badge bg-success text-white"
                      >Auto-preenchido</span
                    >
                  </div>
                  <div class="section-content">
                    <div class="form-row">
                      {% for field in form if field.name in campo_grupos.cliente
                      %}
                      <div class="form-col">{{ render_field(field) }}</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endif %}

                <!-- Endere√ßo Gen√©rico -->
                {% if campo_grupos.endereco %}
                <div class="form-section">
                  <div class="section-header">
                    <h6>
                      <i class="fas fa-map-marker-alt me-2"></i>C. Endere√ßo
                    </h6>
                    <span class="badge bg-success text-white"
                      >Auto-preenchido</span
                    >
                  </div>
                  <div class="section-content">
                    <div class="form-row">
                      {% for field in form if field.name in
                      campo_grupos.endereco %}
                      <div class="form-col">{{ render_field(field) }}</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endif %}

                <!-- Dados do Processo -->
                {% if campo_grupos.processo %}
                <div class="form-section">
                  <div class="section-header">
                    <h6>
                      <i class="fas fa-file-invoice me-2"></i>D. Dados do
                      Processo
                    </h6>
                  </div>
                  <div class="section-content">
                    <div class="form-row">
                      {% for field in form if field.name in
                      campo_grupos.processo %}
                      <div class="form-col">{{ render_field(field) }}</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endif %}

                <!-- SE√á√ÉO DE AUTORIDADES EM CARROSSEL -->
                {% if campo_grupos.autoridades %}
                <div class="form-section">
                  <div class="section-header">
                    <h6>
                      <i class="fas fa-building-shield me-2"></i>E. Autoridades
                      de Tr√¢nsito
                    </h6>
                    <span class="badge bg-info text-white">Carrossel</span>
                  </div>
                  <div class="section-content">
                    <div
                      id="autoridadesCarousel"
                      class="carousel slide"
                      data-bs-interval="false"
                    >
                      <div class="carousel-inner">
                        <!-- Organizar autoridades por √≠ndice -->
                        {% set autoridades_grupos = {} %} {% for field_name in
                        campo_grupos.autoridades %} {% if
                        field_name.startswith('orgao_transito_') %} {% set parts
                        = field_name.split('_') %} {% if parts|length >= 3 and
                        parts[2].isdigit() %} {% set auth_index = parts[2]|int
                        %} {% if auth_index not in autoridades_grupos %} {% set
                        _ = autoridades_grupos.update({auth_index: []}) %} {%
                        endif %} {% set _ =
                        autoridades_grupos[auth_index].append(field_name) %} {%
                        endif %} {% endif %} {% endfor %} {% for auth_index,
                        auth_fields in autoridades_grupos.items()|sort %}
                        <div
                          class="carousel-item {% if loop.first %}active{% endif %}"
                        >
                          <div
                            class="authority-drop-zone mb-3"
                            data-authority-index="{{ auth_index }}"
                          >
                            <h6 class="text-muted mb-3">
                              <i class="fas fa-building me-2"></i>Autoridade {{
                              auth_index }}
                            </h6>
                            <div class="form-row">
                              {% for field in form if field.name in auth_fields
                              %}
                              <div class="form-col">
                                {{ render_field(field) }}
                              </div>
                              {% endfor %}
                            </div>
                            <div class="status-indicator"></div>
                          </div>
                        </div>
                        {% endfor %}
                      </div>
                      <button
                        class="carousel-control-prev"
                        type="button"
                        data-bs-target="#autoridadesCarousel"
                        data-bs-slide="prev"
                      >
                        <span
                          class="carousel-control-prev-icon"
                          aria-hidden="true"
                        ></span>
                        <span class="visually-hidden">Anterior</span>
                      </button>
                      <button
                        class="carousel-control-next"
                        type="button"
                        data-bs-target="#autoridadesCarousel"
                        data-bs-slide="next"
                      >
                        <span
                          class="carousel-control-next-icon"
                          aria-hidden="true"
                        ></span>
                        <span class="visually-hidden">Pr√≥ximo</span>
                      </button>
                    </div>
                  </div>
                </div>
                {% endif %}

                <!-- Polo Ativo -->
                {% if campo_grupos.polo_ativo %}
                <div class="form-section">
                  <div class="section-header">
                    <h6><i class="fas fa-user-plus me-2"></i>F. Polo Ativo</h6>
                  </div>
                  <div class="section-content">
                    <div class="form-row">
                      {% for field in form if field.name in
                      campo_grupos.polo_ativo %}
                      <div class="form-col">{{ render_field(field) }}</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endif %}

                <!-- Polo Passivo -->
                {% if campo_grupos.polo_passivo %}
                <div class="form-section">
                  <div class="section-header">
                    <h6>
                      <i class="fas fa-user-minus me-2"></i>G. Polo Passivo
                    </h6>
                  </div>
                  <div class="section-content">
                    <div class="form-row">
                      {% for field in form if field.name in
                      campo_grupos.polo_passivo %}
                      <div class="form-col">{{ render_field(field) }}</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endif %}

                <!-- Terceiros -->
                {% if campo_grupos.terceiros %}
                <div class="form-section">
                  <div class="section-header">
                    <h6><i class="fas fa-users me-2"></i>H. Terceiros</h6>
                  </div>
                  <div class="section-content">
                    <div class="form-row">
                      {% for field in form if field.name in
                      campo_grupos.terceiros %}
                      <div class="form-col">{{ render_field(field) }}</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endif %}

                <!-- Outros Campos -->
                {% if campo_grupos.outros %}
                <div class="form-section">
                  <div class="section-header">
                    <h6>
                      <i class="fas fa-ellipsis-h me-2"></i>I. Outros Dados
                    </h6>
                  </div>
                  <div class="section-content">
                    <div class="form-row">
                      {% for field in form if field.name in campo_grupos.outros
                      %}
                      <div class="form-col">{{ render_field(field) }}</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endif %}

                <!-- Fallback: Formul√°rio simples se n√£o houver campo_grupos -->
                {% if not campo_grupos or not (campo_grupos.dados_pessoais or
                campo_grupos.documentos or campo_grupos.endereco or
                campo_grupos.autores or campo_grupos.reus or
                campo_grupos.autoridades or campo_grupos.polo_ativo or
                campo_grupos.polo_passivo or campo_grupos.terceiros or
                campo_grupos.outros) %}
                <div class="form-section">
                  <div class="section-header">
                    <h6><i class="fas fa-file-alt me-2"></i>Formul√°rio</h6>
                  </div>
                  <div class="section-content">
                    <div class="form-row">
                      {% for field in form if field.type != 'CSRFTokenField' %}
                      <div class="form-col">{{ render_field(field) }}</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>

              <!-- Bot√µes de A√ß√£o -->
              <div
                class="d-flex justify-content-between align-items-center mt-4 pt-4 border-top"
              >
                <button
                  type="button"
                  @click="generatePreview()"
                  class="btn btn-outline-secondary"
                  :disabled="submitting"
                >
                  <i class="fas fa-eye me-2"></i>Visualizar Preview
                </button>
                <div class="d-flex gap-2">
                  <button
                    type="button"
                    @click="resetForm()"
                    class="btn btn-secondary"
                    :disabled="submitting"
                  >
                    <i class="fas fa-undo me-2"></i>Limpar Formul√°rio
                  </button>
                  <button
                    type="submit"
                    class="btn btn-success btn-lg"
                    :disabled="submitting || !clienteCarregado"
                  >
                    <i
                      class="fas"
                      :class="submitting ? 'fa-spinner fa-spin' : 'fa-file-export'"
                      class="me-2"
                    ></i>
                    <span
                      x-text="submitting ? 'Gerando...' : 'Gerar Documento'"
                    ></span>
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Preview -->
  <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-eye me-2"></i>Preview do Documento
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="preview-panel p-3">
            <div class="text-center py-5 text-muted" x-show="previewLoading">
              <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
              <p>Gerando preview...</p>
            </div>
            <div x-show="!previewLoading" x-html="previewContent"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- O script foi movido para arquivos separados para melhor organiza√ß√£o -->
{% endblock %}
