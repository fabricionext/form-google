{% extends "_base_peticionador.html" %}
{% from "peticionador/_form_macros.html" import render_field %}

{% block title %}{{ form_gerado.nome }} - {{ modelo.nome }} (Vue.js){% endblock %}

{% block head_extra %}
<!-- Meta tag para CSRF -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<!-- Vue.js Application Styles -->
<link rel="stylesheet" href="{{ url_for('peticionador.static', filename='dist/formulario-dinamico.css') }}">

<!-- Font Awesome para √≠cones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Bootstrap 5 (se n√£o estiver no base template) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Estilos customizados para integra√ß√£o -->
<style>
  /* Garantir que o container Vue n√£o conflite com estilos existentes */
  #formulario-dinamico-vue {
    min-height: 400px;
  }
  
  /* Estilos para compatibilidade com sistema existente */
  .formulario-dinamico-app {
    font-family: inherit;
  }
  
  /* Fallback para caso o Vue n√£o carregue */
  .vue-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 200px;
    flex-direction: column;
  }
  
  .vue-error {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 1rem;
    border-radius: 0.375rem;
    margin: 1rem 0;
  }
  
  /* Ocultar formul√°rio original quando Vue estiver ativo */
  .vue-active #formulario-original {
    display: none;
  }
  
  /* Mostrar indicador de carregamento */
  .vue-loading .spinner-border {
    width: 3rem;
    height: 3rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Header da p√°gina -->
      <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
          <i class="fas fa-file-alt"></i>
          {{ form_gerado.nome }}
        </h1>
        <div class="d-flex gap-2">
          <a href="{{ url_for('peticionador.modelos_listar') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i>
            Voltar aos Modelos
          </a>
          <button onclick="window.clearAllDrafts()" class="btn btn-outline-warning" title="Limpar todos os rascunhos">
            <i class="fas fa-broom"></i>
            Limpar Rascunhos
          </button>
        </div>
      </div>

      <!-- Container para aplica√ß√£o Vue.js -->
      <div id="formulario-dinamico-vue">
        <!-- Estado de carregamento -->
        <div class="vue-loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando aplica√ß√£o...</span>
          </div>
          <p class="mt-3 text-muted">Iniciando formul√°rio din√¢mico...</p>
        </div>
      </div>

      <!-- Fallback: Formul√°rio original (caso Vue falhe) -->
      <div id="formulario-original" style="display: none;">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Modo de Compatibilidade:</strong> 
          A vers√£o moderna do formul√°rio n√£o p√¥de ser carregada. Usando vers√£o b√°sica.
        </div>
        
        <form id="peticao_form" method="POST" action="{{ request.url }}" novalidate>
          {{ csrf_token() }}
          
          <!-- Campos b√°sicos do formul√°rio -->
          <div class="row">
            {% for placeholder in placeholders %}
            <div class="col-md-6 mb-3">
              {{ render_field(placeholder) }}
            </div>
            {% endfor %}
          </div>
          
          <div class="form-actions mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="fas fa-file-alt"></i>
              Gerar Documento
            </button>
            <button type="reset" class="btn btn-secondary ms-2">
              <i class="fas fa-eraser"></i>
              Limpar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Dados para o Vue.js -->
<script type="application/json" id="vue-data">
{
  "form_gerado": {{ form_gerado.to_dict() | tojson }},
  "modelo": {{ modelo.to_dict() | tojson }},
  "placeholders": {{ placeholders | map(attribute='chave') | list | tojson }},
  "csrf_token": "{{ csrf_token() }}",
  "api_urls": {
    "clientes": "{{ url_for('peticionador.listar_clientes_api') }}",
    "autoridades": "{{ url_for('peticionador.listar_autoridades_api') }}",
    "submit": "{{ request.url }}"
  }
}
</script>

<!-- Vue.js Application Script -->
<script type="module" src="{{ url_for('peticionador.static', filename='dist/formulario-dinamico.js') }}"></script>

<!-- Script de fallback e detec√ß√£o de erros -->
<script>
  (function() {
    let vueLoaded = false;
    let vueError = null;
    
    // Timeout para detectar se Vue n√£o carregou
    const vueTimeout = setTimeout(() => {
      if (!vueLoaded) {
        console.warn('Vue.js n√£o carregou em 10 segundos, ativando fallback');
        activateFallback('Timeout ao carregar aplica√ß√£o moderna');
      }
    }, 10000);
    
    // Detectar quando Vue carregou com sucesso
    window.addEventListener('vue-loaded', () => {
      vueLoaded = true;
      clearTimeout(vueTimeout);
      document.body.classList.add('vue-active');
      console.log('‚úÖ Vue.js carregado com sucesso');
    });
    
    // Detectar erros do Vue
    window.addEventListener('vue-error', (event) => {
      vueError = event.detail;
      clearTimeout(vueTimeout);
      activateFallback(`Erro na aplica√ß√£o: ${vueError.message}`);
    });
    
    // Detectar erros de JavaScript
    window.addEventListener('error', (event) => {
      if (event.filename && event.filename.includes('formulario-dinamico.js')) {
        clearTimeout(vueTimeout);
        activateFallback(`Erro ao carregar script: ${event.message}`);
      }
    });
    
    function activateFallback(reason) {
      console.warn('Ativando formul√°rio de fallback:', reason);
      
      // Ocultar container Vue
      const vueContainer = document.getElementById('formulario-dinamico-vue');
      if (vueContainer) {
        vueContainer.style.display = 'none';
      }
      
      // Mostrar formul√°rio original
      const originalForm = document.getElementById('formulario-original');
      if (originalForm) {
        originalForm.style.display = 'block';
      }
      
      // Mostrar notifica√ß√£o
      showFallbackNotification(reason);
    }
    
    function showFallbackNotification(reason) {
      const notification = document.createElement('div');
      notification.className = 'vue-error';
      notification.innerHTML = `
        <strong>Informa√ß√£o:</strong> ${reason}
        <br>
        <small>O formul√°rio b√°sico est√° funcionando normalmente.</small>
      `;
      
      const container = document.querySelector('.container-fluid .row .col-12');
      if (container) {
        container.insertBefore(notification, container.firstChild);
      }
    }
    
    // Fun√ß√£o global para limpar rascunhos (compatibilidade)
    window.clearAllDrafts = function() {
      let removed = 0;
      const keysToRemove = [];
      
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('draft_')) {
          keysToRemove.push(key);
        }
      }
      
      keysToRemove.forEach(key => {
        localStorage.removeItem(key);
        removed++;
      });
      
      console.log(`üßπ ${removed} rascunhos removidos do localStorage`);
      alert(`${removed} rascunhos removidos com sucesso!`);
    };
  })();
</script>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Script para integra√ß√£o com sistema existente -->
<script>
  // Compatibilidade com funcionalidades existentes
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ P√°gina carregada - aguardando Vue.js...');
    
    // Configurar dados globais para Vue
    const vueDataElement = document.getElementById('vue-data');
    if (vueDataElement) {
      try {
        window.VUE_INITIAL_DATA = JSON.parse(vueDataElement.textContent);
        console.log('üìä Dados iniciais configurados para Vue:', window.VUE_INITIAL_DATA);
      } catch (error) {
        console.error('‚ùå Erro ao parsear dados iniciais:', error);
      }
    }
  });
</script>
{% endblock %}